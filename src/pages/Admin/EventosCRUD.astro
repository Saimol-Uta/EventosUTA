---
import Header from "@components/Header.astro";
import NavBar from "../../components/Navbar.astro";
import MenuAdmin from "../../components/MenuAdministrador.astro";
import Layout from "../../layouts/Layout.astro";
import ModalDetallesEvento from "../../components/ModalDetallesEvento.astro";
import ModalModificarEvento from "../../components/ModalModificarEvento.astro";
import ModalNuevoEvento from "../../components/ModalNuevoEvento.astro";
import "../../styles/EventosCRUD.css";
import { actions } from "astro:actions";

const searchParams = Astro.url.searchParams;
const categoriaFiltro = searchParams.get("categoria");

// Obtener eventos con información relacionada
const { data, error } = await Astro.callAction(actions.getEventos, {
    categoria: categoriaFiltro || undefined,
});

if (error) {
    console.error("Error al obtener eventos:", error);
}

const eventos = data?.eventos || [];

// Obtener información completa de cada evento
const eventosCompletos = await Promise.all(
    eventos.map(async (evento: any) => {
        const organizador = await Astro.callAction(
            actions.getOrganizadorByEvento,
            { id_evento: evento.id_eve }
        );

        const categoria = await Astro.callAction(
            actions.getCategoriaById,
            { id_categoria: evento.id_cat_eve }
        );

        return {
            ...evento,
            organizador: organizador.data,
            categoria: categoria.data,
        };
    })
);

const links = [
    { label: "Eventos", href: "/" },
    { label: "Usuarios", href: "/perfil" },
    { label: "Organizadores", href: "/historial" },
    { label: "Inscripciones", href: "/historial" },
    { label: "Categorías", href: "/historial" },
    { label: "Carreras", href: "/historial" },
];
---

<Layout>
    <body>
        <Header />
        <MenuAdmin links={links} />
        <ModalDetallesEvento />
        <ModalModificarEvento />
        <ModalNuevoEvento />

        <main class="registros">
            <div class="registros-grid">
                <div class="registros-superior">
                    <div class="registros-superior-izquierdo">
                        Eventos
                        <select
                            id="filtroCategoria"
                            class="select-estado"
                            onchange="window.location.href = `?categoria=${this.value}`"
                        >
                            <option value="" selected={!categoriaFiltro}>
                                Todos los eventos
                            </option>
                            <option
                                value="curso"
                                selected={categoriaFiltro === "curso"}
                            >
                                Cursos
                            </option>
                            <option
                                value="congreso"
                                selected={categoriaFiltro === "congreso"}
                            >
                                Congresos
                            </option>
                            <option
                                value="webinar"
                                selected={categoriaFiltro === "webinar"}
                            >
                                Webinars
                            </option>
                            <option
                                value="conferencia"
                                selected={categoriaFiltro === "conferencia"}
                            >
                                Conferencias
                            </option>
                        </select>
                    </div>
                    <div class="registros-superior-derecho">
                        <a
                            onclick="window.abrirModalNuevo()"
                            class="contenedor-boton-nuevo-registro"
                        >
                            <button class="boton-nuevo-registro" title="Nuevo">
                                Nuevo Evento
                            </button>
                            <p class="anadir-icon">+</p>
                        </a>
                    </div>
                </div>

                <div class="registros-inferior-titulos">
                    <div class="registro-fila">
                        <div class="parte-izquierda-registro-encabezado">
                            Nombre
                        </div>
                        <div class="parte-izquierda-registro-encabezado">
                            Categoría
                        </div>
                        <div class="parte-izquierda-registro-encabezado">
                            Área
                        </div>
                        <div class="parte-izquierda-registro-encabezado">
                            Fecha Inicio
                        </div>
                        <div class="parte-izquierda-registro-encabezado">
                            Ubicación
                        </div>
                        <div class="parte-derecha-registro-encabezado">
                            Opciones
                        </div>
                    </div>
                </div>
                <div class="registros-inferior">
                    {
                        eventosCompletos.map((evento) => (
                            <input
                                type="hidden"
                                name="evento"
                                value={JSON.stringify(evento)}
                            />
                            <div class="registro-fila">
                                <div class="parte-izquierda-registro-fila">
                                    {evento.nom_eve}
                                </div>
                                <div class="parte-izquierda-registro-fila">
                                    {evento.categoria?.data?.nom_cat || "N/A"}
                                </div>
                                <div class="parte-izquierda-registro-fila">
                                    {evento.are_eve || "N/A"}
                                </div>
                                <div class="parte-izquierda-registro-fila">
                                    {new Date(evento.fec_ini_eve)
                                        .toISOString()
                                        .split("T")[0]}
                                </div>
                                <div class="parte-izquierda-registro-fila">
                                    {evento.ubi_eve}
                                </div>
                                <div class="registro-opciones">
                                    <button
                                        title="Detalles"
                                        onclick={`mostrarDetallesEvento('${evento.id_eve}')`}
                                    >
                                        <img
                                            src="/img/CRUD/mostrar-detalles.svg"
                                            alt="boton mostrar detalles"
                                            class="imagen-boton-registro"
                                        />
                                    </button>
                                    <button
                                        title="Eliminar"
                                        onclick={`eliminarEvento('${evento.id_eve}')`}
                                    >
                                        <img
                                            src="/img/CRUD/eliminar-registro.svg"
                                            alt="boton eliminar registro"
                                            class="imagen-boton-registro"
                                        />
                                    </button>
                                    <button
                                        title="Modificar"
                                        onclick={`window.abrirModal('${evento.id_eve}')`}
                                    >
                                        <img
                                            src="/img/CRUD/modificar-registro.svg"
                                            alt="boton modificar"
                                            class="imagen-boton-modificar"
                                        />
                                    </button>
                                </div>
                            </div>
                        ))
                    }
                </div>
            </div>
        </main>

        <script>
            import { actions } from "astro:actions";
            import Swal from "sweetalert2";

            // Interfaces para tipado
            interface Organizador {
                ced_org: string;
                nom_org1: string;
                nom_org2?: string;
                ape_org1: string;
                ape_org2: string;
                tit_aca_org: string;
            }

            interface Categoria {
                id_cat: string;
                nom_cat: string;
                des_cat: string;
            }

            interface Evento {
                id_eve: string;
                nom_eve: string;
                des_eve: string;
                fec_ini_eve: string;
                fec_fin_eve?: string;
                hor_ini_eve: string;
                hor_fin_eve?: string;
                dur_eve?: number;
                are_eve?: string;
                ubi_eve: string;
                img_eve?: string;
                precio: number;
                organizador?: Organizador;
                categoria?: Categoria;
            }

            async function eliminarEvento(eventoId: string) {
                try {
                    const resultado = await Swal.fire({
                        title: "¿Estás seguro?",
                        text: "No podrás revertir esta acción",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#dc2626",
                        cancelButtonColor: "#6b7280",
                        confirmButtonText: "Sí, eliminar",
                        cancelButtonText: "Cancelar",
                    });

                    if (resultado.isConfirmed) {
                        const { data, error } = await actions.eliminarEvento({
                            id_evento: eventoId,
                        });

                        if (error || !data?.success) {
                            await Swal.fire({
                                icon: "error",
                                title: "Error",
                                text: data?.error || "No se pudo eliminar el evento",
                                confirmButtonColor: "#dc2626",
                            });
                        } else {
                            await Swal.fire({
                                icon: "success",
                                title: "Eliminado",
                                text: "El evento ha sido eliminado correctamente",
                                confirmButtonColor: "#059669",
                            }).then(() => {
                                window.location.reload();
                            });
                        }
                    }
                } catch (error) {
                    console.error("Error:", error);
                    await Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: "Error al procesar la solicitud",
                        confirmButtonColor: "#dc2626",
                    });
                }
            }

            async function mostrarDetallesEvento(eventoId: string) {
                const modal = document.getElementById("modalDetallesReserva");
                if (!modal) return;

                // Obtener el evento del input hidden
                const eventoInput = document.querySelector('input[name="evento"]') as HTMLInputElement;
                if (!eventoInput) return;

                const eventos = Array.from(document.querySelectorAll('input[name="evento"]'))
                    .map(input => JSON.parse((input as HTMLInputElement).value));
                
                const evento = eventos.find((e: Evento) => e.id_eve === eventoId);
                
                if (!evento) {
                    console.error('Evento no encontrado');
                    return;
                }

                // Actualizar título del modal
                const titulo = modal.querySelector('h2');
                if (titulo) {
                    titulo.textContent = evento.nom_eve;
                }

                // Actualizar imagen
                const imagen = modal.querySelector('.imagen-curso') as HTMLImageElement;
                if (imagen) {
                    imagen.src = evento.img_eve || 'https://via.placeholder.com/300x200?text=Sin+Imagen';
                }

                // Actualizar descripción
                const descripcion = modal.querySelector('#cliente-cedula');
                if (descripcion) {
                    descripcion.textContent = evento.des_eve;
                }

                // Actualizar información general
                const infoElements = modal.querySelectorAll('#cliente-telefono');
                if (infoElements.length >= 3) {
                    infoElements[0].textContent = evento.categoria?.nom_cat || 'N/A';
                    infoElements[1].textContent = evento.are_eve || 'N/A';
                    infoElements[2].textContent = 'General'; // Asignación por defecto
                }

                // Actualizar programación
                const progElements = modal.querySelectorAll('#vehiculo-info, #vehiculo-tipo, #vehiculo-transmision, #vehiculo-combustible');
                if (progElements.length >= 6) {
                    progElements[0].textContent = new Date(evento.fec_ini_eve).toLocaleDateString();
                    progElements[1].textContent = evento.hor_ini_eve ? new Date(`1970-01-01T${evento.hor_ini_eve}`).toLocaleTimeString() : 'N/A';
                    progElements[2].textContent = evento.fec_fin_eve ? new Date(evento.fec_fin_eve).toLocaleDateString() : 'N/A';
                    progElements[3].textContent = evento.hor_fin_eve ? new Date(`1970-01-01T${evento.hor_fin_eve}`).toLocaleTimeString() : 'N/A';
                    progElements[4].textContent = evento.dur_eve ? `${evento.dur_eve} horas` : 'N/A';
                    progElements[5].textContent = evento.ubi_eve;
                }

                // Actualizar organizador
                const orgElements = modal.querySelectorAll('#reserva-inicio, #reserva-fin, #reserva-estado');
                if (orgElements.length >= 3 && evento.organizador) {
                    orgElements[0].textContent = evento.organizador.ced_org;
                    orgElements[1].textContent = `${evento.organizador.nom_org1} ${evento.organizador.ape_org1} ${evento.organizador.ape_org2}`;
                    orgElements[2].textContent = evento.organizador.tit_aca_org;
                }

                modal.style.display = "block";
            }

            // Hacer funciones disponibles globalmente
            declare global {
                interface Window {
                    eliminarEvento: (eventoId: string) => Promise<void>;
                    mostrarDetallesEvento: (eventoId: string) => Promise<void>;
                }
            }

            window.eliminarEvento = eliminarEvento;
            window.mostrarDetallesEvento = mostrarDetallesEvento;
        </script>
    </body>
</Layout>
