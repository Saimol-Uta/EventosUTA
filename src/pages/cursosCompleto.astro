---
import Header from "../components/Header.astro";
import Navbar from "../components/Navbar.astro";
import Layout from "../layouts/Layout.astro";
import MenuAdmin from "../components/MenuAdministrador.astro";
import Filtros from "../components/filtros.astro";
import { actions } from "astro:actions";
import type { CustomUser } from "../../auth.config";
import { getSession } from "auth-astro/server";
import ContenedorEventos from "../components/ContenedorEvento.astro";

// Extraer filtros desde la URL
const url = new URL(Astro.request.url);
const filtros = {

  categoria: url.searchParams.get("categoria") || "",
  duracion: url.searchParams.get("duracion") || "",

};

// Extraer número de página, por defecto 1
const page = parseInt(url.searchParams.get("page") || "1", 10);

// Número de cursos por página (configurable)
const cursosPorPagina = 8;

const session = await getSession(Astro.request);
let esAdmin = false;

if (session && session.user) {
  const user = session.user as CustomUser;
  const rol = user.rol?.toUpperCase();
  if (rol === "ADMINISTRADOR" || rol === "MASTER") {
    esAdmin = true;
  }
}
---

<Layout>
  <Header />
  {esAdmin ? <MenuAdmin /> : <Navbar />}

  <section class="contenedor-titulo">
    <Filtros />
    <!-- Buscador -->
    <div class="flex justify-end my-3 absolute right-16 bottom-1">
      <div
        class="flex items-stretch w-full max-w-sm bg-white shadow-md ring-1 ring-[#800000] overflow-hidden"
      >
        <input
          type="text"
          placeholder="Buscar evento"
          class="input-busqueda flex-grow bg-transparent outline-none text-gray-800 placeholder-gray-400 px-4 py-2 text-sm"
        />
        <button
          class="btn-buscar text-white px-4 flex items-center justify-center transition duration-300"
          title="Buscar"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M21 21l-4.35-4.35m0 0A7 7 0 104.64 4.64a7 7 0 0011.01 11.01z"
            ></path>
          </svg>
        </button>
      </div>
    </div>

    <div class="contenedor-interno">
      <h2 class="titulo-seccion">Eventos</h2>
      <span class="block h-[3px] w-[66px] bg-red-900"></span>
    </div>
  </section>
  <section class="seccion-principal">
    {
      (filtros.categoria || filtros.duracion) && (
        <div class="filtros-activos">
          <span class="titulo-filtros"> Filtros aplicados:</span>

          {filtros.categoria && (
            <span class="filtro-tag">
              Categoría: <strong>{filtros.categoria}</strong>
              <button class="cerrar-filtro" onclick="quitarFiltro('categoria')">
                ×
              </button>
            </span>
          )}

          {filtros.duracion && (
            <span class="filtro-tag">
              Duración: <strong>{filtros.duracion}</strong>
              <button class="cerrar-filtro" onclick="quitarFiltro('duracion')">
                ×
              </button>
            </span>
          )}

        <a href="/cursosCompleto" class="btn-limpiar-filtros">
            Ver todos los cursos
          </a>
        </div>
        
      )
    }

    <!-- Eventos filtrados con paginación -->
    <ContenedorEventos
      filtros={filtros}
      page={page}
      cursosPorPagina={cursosPorPagina}
      modoAdmin={esAdmin}
    />
    {
      esAdmin && (
        <div style="margin-top: 20px; text-align: right;">
          <button
            id="btn-guardar-favoritos"
            class="btn-buscar"
            disabled
            onclick="guardarFavoritos()"
          >
            Guardar Eventos Favoritos
          </button>
        </div>
      )
    }

    <div class="cursos-sin-resultados" style="display: none;">
      <svg
        class="icono-vacio"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 64 64"
        fill="none"
      >
        <circle
          cx="32"
          cy="32"
          r="30"
          stroke="#8A1538"
          stroke-width="3"
          fill="#fff8f8"></circle>
        <circle cx="22" cy="24" r="4" fill="#8A1538"></circle>
        <circle cx="42" cy="24" r="4" fill="#8A1538"></circle>
        <path
          d="M22 44c2.5-4 9.5-4 12 0"
          stroke="#8A1538"
          stroke-width="2.5"
          stroke-linecap="round"></path>
      </svg>
      <p class="titulo-vacio">¡Ups! No se encontraron resultados</p>
      <p class="texto-vacio">Prueba buscando otro evento</p>
    </div>
  </section>

  <style>
    .seccion-principal {
      padding: 20px 40px;
    }

    .contenedor-titulo {
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: rgb(245, 245, 245);
      height: 180px;
      position: relative;
      padding-bottom: 30px;
    }

    .contenedor-interno {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .titulo-seccion {
      font-size: 52px;
      color: rgb(17, 17, 17);
      font-weight: 500;
    }

    .filtro-tag {
      background-color: #fff;
      border: 1px solid rgb(108, 19, 19);
      padding: 6px 14px;
      color: rgb(108, 19, 19);
      font-size: 0.85rem;
      margin-right: 20px;
    }

    .titulo-filtros {
      font-weight: 600;
      color: rgb(108, 19, 19);
      margin-right: 10px;
    }

    .btn-limpiar-filtros {
      margin-left: auto;
      color: rgb(108, 19, 19);
      font-weight: 500;
      text-decoration: none;
      font-size: 0.85rem;
      padding: 6px 12px;
      background-color: #f0f0f0;
      transition: background 0.2s ease;
    }

    .btn-limpiar-filtros:hover {
      background-color: #e4e4e4;
    }

    .cerrar-filtro {
      background: none;
      border: none;
      font-size: 14px;
      color: #8a1538;
      margin-left: 8px;
      cursor: pointer;
      padding: 0;
      font-weight: bold;
      line-height: 1;
    }

    .cerrar-filtro:hover {
      color: rgb(108, 19, 19);
    }
    
    .filtros-activos {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 0 18px;
    }

    .input-busqueda {
      padding: 8px 12px;
      width: 220px;
      font-size: 14px;
      background-color: transparent;
    }

    .btn-buscar {
      padding: 8px 14px;
      background-color: rgb(108, 19, 19);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }

    .sin-resultados {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
      color: #333;
      max-width: 100%;
      margin: 0 auto;
      background-color: #fff6f6;
      border: 1px solid #f3caca;
      border-radius: 12px;
    }

    .sin-resultados {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
      color: #333;
      max-width: 100%;
      margin: 0 auto;
      background-color: #fff6f6;
      border: 1px solid #f3caca;
      border-radius: 12px;
    }

    .sin-resultados svg {
      width: 120px;
      height: 120px;
      margin-bottom: 20px;
    }

    .titulo-vacio {
      font-size: 1.2rem;
      font-weight: bold;
      color: #8a1538;
      margin-bottom: 8px;
    }

    .texto-vacio {
      font-size: 0.95rem;
      color: #444;
    }
    .btn-favorito {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #ccc;
    }

    .btn-favorito.activo {
      color: rgb(229, 5, 16);
    }

  <script src="/js/filtros.js" defer is:inline></script>
</Layout>
