---
import Header from "../components/HeaderUsuario.astro";
import NavBar from "../components/Navbar.astro";
import MenuAdmin from "../components/MenuAdministrador.astro";
import Avatar from "../components/Avatar.astro";
import Button from "../components/Button.astro";
import DocumentButton from "../components/DocumentButton.astro";
import Card from "../components/Card.astro";
import { actions } from "astro:actions";
import type { CustomUser } from "../../auth.config";
import { getSession } from "auth-astro/server";

const links = [
    { label: "Eventos", href: "/" },
    { label: "Usuarios", href: "/perfil" },
    { label: "Organizadores", href: "/historial" },
    { label: "Inscripciones", href: "/historial" },
    { label: "Categorías", href: "/historial" },
    { label: "Carreras", href: "/historial" },
];

const upcomingEvents = [
    "Evento 1",
    "Evento 2",
    "Evento 3",
    "Evento 4",
    "Evento 5",
];
const inscripcionesPendientes = [
    "Inscripción 1",
    "Inscripción 2",
    "Incripción 3",
    "Incripción 4",
    "Inscripción 5",
];

const session = await getSession(Astro.request);

// Si no hay sesión, redirigir al login
let nombreAdmin='';

if (session && session.user) {
    const user = session.user as CustomUser;
    const idUsuario = user.id;
    nombreAdmin = user.name || "";
    const rol = user.rol;

    let eventos = [];
    let success = false;

    if (idUsuario) {
        const result = await Astro.callAction(actions.getEventosPorUsuario, {
            idUsuario,
        });
        if (result && result.data) {
            success = result.data.success;
            eventos = result.data.eventos || [];
        }
    }
}
---

<html lang="es">
    <head>
        <meta charset="UTF-8" />
    </head>
    <body>
        <Header />
        <NavBar />
        <MenuAdmin links={links} />

        <div class="flex flex-col md:flex-row gap-6 p-6">
            <div class="flex flex-col items-center gap-4 w-full md:w-1/4">
                <Avatar />
               <p class="text-red-800 font-semibold text-lg"> {nombreAdmin} </p>
                <Button text="Editar Perfil" />
                <div class="text-center mt-4 text-red-800">Documentos</div>
                <div class="flex gap-2 mt-2">
                    <DocumentButton label="pdf cedula" />
                    <DocumentButton label="pdf matric" />
                    <DocumentButton label="pdf extra" />
                </div>
            </div>

            <div class="w-full md:w-3/4 flex flex-col gap-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-12">
                    <!-- Inscripciones Pendientes -->
                    <Card title="Inscripciones Pendientes">
                        <div class="flex flex-col gap-y-4">
                            {
                                inscripcionesPendientes
                                    .slice(0, 4)
                                    .map((c) => (
                                        <div class="bg-white border rounded-xl shadow-md p-4 text-gray-800">
                                            {c}
                                        </div>
                                    ))
                            }
                            {
                                inscripcionesPendientes.length > 4 && (
                                    <a
                                        href="/inscripciones"
                                        class="text-red-800 underline text-sm mt-2"
                                    >
                                        Ver más...
                                    </a>
                                )
                            }
                        </div>
                    </Card>

                    <!-- Eventos Próximos -->
                    <Card title="Eventos Próximos">
                        <div class="flex flex-col gap-y-4">
                            {
                                upcomingEvents
                                    .slice(0, 4)
                                    .map((e) => (
                                        <div class="bg-white border rounded-xl shadow-md p-4 text-gray-800">
                                            {e}
                                        </div>
                                    ))
                            }
                            {
                                upcomingEvents.length > 4 && (
                                    <a
                                        href="/eventos"
                                        class="text-red-800 underline text-sm mt-2"
                                    >
                                        Ver más...
                                    </a>
                                )
                            }
                        </div>
                    </Card>
                </div>
            </div>
        </div>
    </body>
</html>
