---
import InformacionUsuarioItem from "../components/InformacionUsuarioItem.astro";
import InformacionUsuario from "../components/InformacionUsuario.astro";
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Navbar from "../components/Navbar.astro";

const method = Astro.request.method;
let cedulaIngresada = "";
let mostrarFormulario = false;
let mostrarError = false;
let usuarioExistente = false;

if (method === "POST") {
  const formData = await Astro.request.formData();
  cedulaIngresada = formData.get("ced_usu")?.toString() ?? "";

  if (/^\d{10}$/.test(cedulaIngresada)) {
    mostrarFormulario = true;

    // Simulamos que si es esta cédula, el usuario existe
    if (cedulaIngresada === "1851014348") {
      usuarioExistente = true;
    }
  } else {
    mostrarError = true;
  }
}

const camposFormulario = [
  { titulo: "Cédula", valor: cedulaIngresada, name: "ced_usu" },
  { titulo: "Primer nombre", valor: usuarioExistente ? "María" : "", name: "nom_usu1" },
  { titulo: "Segundo nombre", valor: usuarioExistente ? "Fernanda" : "", name: "nom_usu2" },
  { titulo: "Primer apellido", valor: usuarioExistente ? "Vera" : "", name: "ape_usu1" },
  { titulo: "Segundo apellido", valor: usuarioExistente ? "López" : "", name: "ape_usu2" },
  { titulo: "Fecha de nacimiento", valor: usuarioExistente ? "1995-08-15" : "", name: "fec_nac_usu" },
  { titulo: "Teléfono", valor: usuarioExistente ? "0999988776" : "", name: "num_tel_usu" },
  { titulo: "Contraseña", valor: "", name: "contrasena" },
  { titulo: "Carrera", valor: usuarioExistente ? "carrera-id-abc" : "", name: "id_car_per" }
];

const textoPrincipal = usuarioExistente ? "¿Asociar este usuario a la cuenta?" : "Guardar Información";
const textoSecundario = usuarioExistente ? "Cancelar" : "Más Tarde";
const eventoSecundario = usuarioExistente ? "cancelarFormulario()" : "location.reload()";
---

<Layout>
  <Header />
  <Navbar />

  <div class="bg-gray-100 min-h-screen py-10">
    <div class="max-w-3xl mx-auto px-4 text-center">

      {mostrarFormulario ? (
        <InformacionUsuario
          camposFormulario={camposFormulario}
          mostrarBotones={true}
          textoBotonPrincipal={textoPrincipal}
          textoBotonSecundario={textoSecundario}
        />
      ) : (
        <form method="POST" class="formulario-container formulario-grid">
          <div class="campo-item">
            <label for="ced_usu">Ingrese su número de Cédula</label>
            <input
              type="text"
              id="ced_usu"
              name="ced_usu"
              value={cedulaIngresada}
              placeholder="Ej. 0101010101"
              required
            />
          </div>

          <div class="formulario-boton">
            <button type="submit">Continuar</button>
          </div>

          {mostrarError && (
            <p class="text-red-600 text-sm mt-2" style="grid-column: 1 / -1;">
              Cédula inválida o no encontrada
            </p>
          )}
        </form>
      )}
    </div>
  </div>
</Layout>

<script is:inline>
  function cancelarFormulario() {
    window.location.href = window.location.pathname;
  }
</script>


<style>
.formulario-container {
  background-color: #eee;
  border-radius: 8px;
  padding: 2rem;
  max-width: 500px;
  margin: 2rem auto;
  font-family: 'Segoe UI', sans-serif;
  box-shadow: 0 0 4px rgba(0,0,0,0.1);
}

.formulario-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1.5rem;
}

.campo-item {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.campo-item label {
  font-weight: bold;
  color: #8B0000;
  font-size: 14px;
}

.campo-item input {
  padding: 10px;
  font-size: 15px;
  border: 1px solid #ccc;
  border-radius: 6px;
  outline: none;
}

.campo-item input:focus {
  border-color: #8B0000;
  box-shadow: 0 0 0 2px rgba(139, 0, 0, 0.2);
}

.formulario-boton {
  text-align: center;
}

.formulario-boton button {
  background-color: #8B0000;
  color: white;
  font-size: 16px;
  padding: 10px 30px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.formulario-boton button:hover {
  background-color: #a00;
}
</style>

