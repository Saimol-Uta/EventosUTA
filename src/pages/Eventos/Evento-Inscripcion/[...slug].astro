---
import { getSession } from "auth-astro/server";
import { actions } from "astro:actions";
import Layout from "@/layouts/Layout.astro";
import FormularioInscripcion2 from "@/components/Eventos/FormularioInscripcion2.astro";
import "@styles/global.css";

// 1. Obtener el parámetro slug desde la URL
const { slug } = Astro.params;
if (!slug) {
  return Astro.redirect("/404");
}
const idEvento = slug;

// 2. Obtener sesión del usuario
const session = await getSession(Astro.request);
if (!session?.user) {
  return Astro.redirect("/login");
}
const idUsuario = session.user.id;
if (!idUsuario) {
  throw new Error("El usuario no tiene un ID válido.");
}

// 3. Llamar la acción para obtener los datos del formulario
const { data, error } = await Astro.callAction(actions.getDatosInscripcion, {
  idUsuario,
  idEvento,
});

if (error || !data?.data || !data.data.evento) {
  return Astro.redirect("/404");
}

// 4. Extraer los datos
const { usuario, evento, inscripcion, requisitos } = data.data;


// 5. Campos de texto para el formulario
const campoTexto1 = "Cédula";
const campoTexto2 = "Nombres";
const campoTexto3 = "Apellidos";
const campoTexto4 = "Correo electrónico";
const campoTexto5 = "Teléfono";
const campoArchivo = "Suba su documento";
---

<Layout>
    <pre style="background: #f0f0f0; padding: 1em; font-size: 0.9em; overflow-x: auto;">
    {JSON.stringify(usuario, null, 2)}
  </pre>
  <FormularioInscripcion2
    campoTitle={evento.nom_eve}
    campoTexto1={campoTexto1}
    campoTexto2={campoTexto2}
    campoTexto3={campoTexto3}
    campoTexto4={campoTexto4}
    campoTexto5={campoTexto5}
    campoArchivo={campoArchivo}
    usuario={usuario}
    evento={evento}
    requisitos={requisitos}
  />
</Layout>

