---
import Header from "../components/Header.astro";
import NavBar from "../components/Navbar.astro";
import ContenedorEvento from "../components/ContenedorEvento.astro";
import EventoUsuario from "../components/EventoUsuario.astro";
import Avatar from "../components/Avatar.astro";
import Button from "../components/Button.astro";
import DocumentButton from "../components/DocumentButton.astro";
import Card from "../components/Card.astro";
import { actions } from "astro:actions";
import type { CustomUser } from "../../auth.config";
import { effect } from "astro:schema";
import { getSession } from "auth-astro/server";
const session = await getSession(Astro.request);

const { data: cuenta } = await Astro.callAction(
    actions.getCuentaById,
    session?.user?.id || "",
);

console.log(cuenta);

const result = await Astro.callAction(actions.getEventosPorUsuario, {
    idUsuario: session?.user?.id || "",
});

const upcomingEvents = ["Evento 1", "Evento 2"]; // o cambia según tu modelo
const certificates = ["Certificado A", "Certificado B"]; // si tienes una tabla real, cámbiala
---

<html lang="es">
    <head>
        <meta charset="UTF-8" />
    </head>
    <body>
        <Header />
        <NavBar />

        <div class="flex flex-col md:flex-row gap-6 p-6">
            <div class="flex flex-col items-center gap-4 w-full md:w-1/4">
                <Avatar
                    defaultSrc={cuenta?.img_user || "/PerfilDefault.png"}
                    size="w-50 h-50"
                />
                <p class="text-red-800 font-semibold text-lg">
                    {session?.user?.name || "Usuario Anónimo"}
                </p>
                <Button text="Editar Perfil" />
                <div class="text-center mt-4 text-red-800">Documentos</div>
                <div class="flex gap-2 mt-2">
                    <DocumentButton label="pdf cédula" />
                    <DocumentButton label="pdf matrícula" />
                    <DocumentButton label="pdf extra" />
                </div>
            </div>

            <div class="w-full md:w-3/4 flex flex-col gap-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-8">
                    <Card title="Eventos Próximos">
                        <div class="flex flex-col gap-y-4">
                            {
                                upcomingEvents
                                    .slice(0, 4)
                                    .map((e) => (
                                        <div class="bg-white border rounded-xl shadow-md p-4 text-gray-800">
                                            {e}
                                        </div>
                                    ))
                            }
                            {
                                upcomingEvents.length > 4 && (
                                    <a
                                        href="/eventos"
                                        class="text-red-800 underline text-sm mt-2"
                                    >
                                        Ver más...
                                    </a>
                                )
                            }
                        </div>
                    </Card>

                    <Card title="Certificados">
                        <div class="flex flex-col gap-y-4">
                            {
                                certificates
                                    .slice(0, 4)
                                    .map((c) => (
                                        <div class="bg-white border rounded-xl shadow-md p-4 text-gray-800">
                                            {c}
                                        </div>
                                    ))
                            }
                            {
                                certificates.length > 4 && (
                                    <a
                                        href="/certificados"
                                        class="text-red-800 underline text-sm mt-2"
                                    >
                                        Ver más...
                                    </a>
                                )
                            }
                        </div>
                    </Card>
                </div>

                <h1 class="text-xl font-semibold mt-8 text-red-800">
                    Historial de Eventos
                </h1>
                <EventoUsuario eventos={result.data?.eventos} />
            </div>
        </div>
    </body>
</html>
