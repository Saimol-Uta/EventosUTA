---
import "../../../styles/Admin/ModalModificarEvento.css";

interface Props {
    categorias?: any[];
    organizadores?: any[];
}

const { categorias = [], organizadores = [] } = Astro.props;
---

<div id="modalNuevoEvento" class="modal">
    <div class="modal-contenido">
        <span class="cerrar" onclick="cerrarModalNuevoEvento()">&times;</span>
        <div class="formulario-completo">
            <form
                class="formulario-modificar-registro"
                method="POST"
                id="formulario-nuevo-evento"
                enctype="multipart/form-data"
            >
                <div class="contenedor-superior">
                    <p class="texto-centrado texto-roja">Informaci√≥n General</p>

                    <div class="contenedor-dato">
                        <p class="texto-dato">Nombre</p>
                        <div class="contenedor-input">
                            <input
                                type="text"
                                class="input-dato"
                                name="nombre"
                                required
                            />
                        </div>
                    </div>

                    <div class="contenedor-dato">
                        <p class="texto-dato">Descripci√≥n</p>
                        <div class="contenedor-input">
                            <textarea
                                class="input-dato"
                                name="descripcion"
                                rows="3"
                                required></textarea>
                        </div>
                    </div>

                    <div class="contenedor-nombre">
                        <div class="contenedor-dato">
                            <p class="texto-dato">Cupo M√°ximo</p>
                            <div class="contenedor-input">
                                <input
                                    type="number"
                                    min="1"
                                    step="1"
                                    class="input-dato"
                                    name="cup_max"
                                    required
                                    placeholder="Ej: 40"
                                />
                            </div>
                        </div>
                        <div class="contenedor-dato">
                            <p class="texto-dato">Categor√≠a:</p>
                            <div class="contenedor-input">
                                <select
                                    name="categoria"
                                    class="input-dato"
                                    required
                                    onchange="mostrarInfoCategoriaNuevo(this)"
                                >
                                    <option value="">Elija una Categor√≠a</option
                                    >
                                    {
                                        categorias.map((categoria) => (
                                            <option
                                                value={categoria.id_cat}
                                                data-puntaje={
                                                    categoria.pun_apr_cat
                                                }
                                                data-asignacion={
                                                    categoria.asi_cat
                                                }
                                                data-requiere-puntaje={
                                                    categoria.requiere_puntaje
                                                }
                                                data-requiere-asistencia={
                                                    categoria.requiere_asistencia
                                                }
                                                data-brinda-certificado={
                                                    categoria.brinda_certificado
                                                }
                                                data-porcentaje-asistencia={
                                                    categoria.porcentaje_asistencia
                                                }
                                            >
                                                {categoria.nom_cat}
                                            </option>
                                        ))
                                    }
                                </select>
                            </div>
                        </div>
                        <!-- Informaci√≥n din√°mica de la categor√≠a -->
                        <div
                            id="info-categoria-nuevo"
                            class="contenedor-dato"
                            style="display: none;"
                        >
                            <p class="texto-dato">
                                Informaci√≥n de la Categor√≠a
                            </p>
                            <div class="info-categoria-contenido">
                                <div
                                    id="info-puntaje-nuevo"
                                    style="display: none;"
                                >
                                    <p class="info-item">
                                        <strong>Puntaje de aprobaci√≥n:</strong>
                                        <span id="valor-puntaje-nuevo">-</span> puntos
                                    </p>
                                </div>
                                <div
                                    id="info-asistencia-nuevo"
                                    style="display: none;"
                                >
                                    <p class="info-item">
                                        <strong>Requiere asistencia:</strong>
                                        <span
                                            id="valor-porcentaje-asistencia-nuevo"
                                            >-</span
                                        >% m√≠nimo
                                    </p>
                                </div>

                                <div
                                    id="info-certificado-nuevo"
                                    style="display: none;"
                                >
                                    <p class="info-item">
                                        <strong>Brinda certificado:</strong> S√≠
                                    </p>
                                </div>
                            </div>
                        </div>
                        <!-- Campos adicionales basados en categor√≠a - OCULTOS -->
                        <div
                            id="campos-puntaje-nuevo"
                            class="contenedor-dato"
                            style="display: none;"
                        >
                            <!-- Campo oculto para mantener funcionalidad -->
                            <input
                                type="hidden"
                                name="puntaje_aprobacion"
                                value=""
                            />
                        </div>

                        <div
                            id="campos-asistencia-nuevo"
                            class="contenedor-dato"
                            style="display: none;"
                        >
                            <!-- Campo oculto para mantener funcionalidad -->
                            <input
                                type="hidden"
                                name="porcentaje_asistencia"
                                value=""
                            />
                        </div>

                        <div class="contenedor-dato">
                            <p class="texto-dato">√Årea:</p>
                            <div class="contenedor-input">
                                <select name="area" class="input-dato">
                                    <option value="">Elija una √Årea</option>
                                    <option value="PRACTICA">Pr√°ctica</option>
                                    <option value="INVESTIGACION"
                                        >Investigaci√≥n</option
                                    >
                                    <option value="ACADEMICA">Acad√©mica</option>
                                    <option value="TECNICA">T√©cnica</option>
                                    <option value="INDUSTRIAL"
                                        >Industrial</option
                                    >
                                    <option value="EMPRESARIAL"
                                        >Empresarial</option
                                    >
                                    <option value="IA">IA</option>
                                    <option value="REDES">Redes</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="contenedor-nombre">
                        <div class="contenedor-dato">
                            <p class="texto-dato">¬øEs gratuito?</p>
                            <div class="contenedor-input">
                                <select
                                    name="es_gratuito-nuevo"
                                    class="input-dato"
                                    onchange="togglePrecioNuevo(this)"
                                >
                                    <option value="true">S√≠, es gratuito</option
                                    >
                                    <option value="false"
                                        >No, tiene costo</option
                                    >
                                </select>
                            </div>
                        </div>

                        <div class="contenedor-dato">
                            <p class="texto-dato">
                                ¬øRequiere carta de motivaci√≥n?
                            </p>
                            <div class="contenedor-input">
                                <select
                                    name="requiere_carta"
                                    class="input-dato"
                                >
                                    <option value="false">No</option>
                                    <option value="true">S√≠</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- Campo oculto para es_destacado con valor por defecto false -->
                    <input type="hidden" name="es_destacado" value="false" />

                    <div class="contenedor-dato" style="display: none;">
                        <p class="texto-dato">Carta de motivaci√≥n:</p>
                        <div class="contenedor-input">
                            <textarea
                                class="input-dato"
                                name="carta_motivacion"
                                rows="2"
                                placeholder="Texto opcional para carta de motivaci√≥n"
                                >Es un evento</textarea
                            >
                        </div>
                    </div>

                    <div
                        class="contenedor-dato"
                        id="contenedor-precio-nuevo"
                        style="display: none;"
                    >
                        <p class="texto-dato">Precio (USD):</p>
                        <div class="contenedor-input">
                            <input
                                type="number"
                                step="0.01"
                                min="0"
                                class="input-dato"
                                name="precio"
                                value="0"
                                onchange="toggleGratuitoNuevo(this)"
                            />
                        </div>
                    </div>
                </div>
                <div class="contenedor-superior">
                    <p class="texto-centrado texto-roja">
                        Programaci√≥n del Evento
                    </p>
                    <div class="contenedor-nombre">
                        <div class="contenedor-dato">
                            <p class="texto-dato">
                                Fecha de Inicio del Evento:
                            </p>
                            <div class="contenedor-input">
                                <input
                                    type="date"
                                    class="input-dato"
                                    name="fecha_inicio"
                                    id="fecha_inicio_nuevo"
                                    required
                                />
                            </div>
                        </div>

                        <div class="contenedor-dato">
                            <p class="texto-dato">
                                Fecha de Finalizaci√≥n del Evento:
                            </p>
                            <div class="contenedor-input">
                                <input
                                    type="date"
                                    class="input-dato"
                                    name="fecha_fin"
                                    id="fecha_fin_nuevo"
                                />
                            </div>
                        </div>
                    </div>

                    <div class="contenedor-nombre">
                        <div class="contenedor-dato">
                            <p class="texto-dato">Inicio de Inscripciones:</p>
                            <div class="contenedor-input">
                                <input
                                    type="date"
                                    class="input-dato"
                                    name="fecha_inicio_inscripciones"
                                    id="fecha_inicio_inscripciones_nuevo"
                                    required
                                />
                            </div>
                        </div>

                        <div class="contenedor-dato">
                            <p class="texto-dato">Fin de Inscripciones:</p>
                            <div class="contenedor-input">
                                <input
                                    type="date"
                                    class="input-dato"
                                    name="fecha_fin_inscripciones"
                                    id="fecha_fin_inscripciones_nuevo"
                                    required
                                />
                            </div>
                        </div>
                    </div>
                    <div class="contenedor-dato">
                        <p class="texto-dato">Duraci√≥n (Horas)</p>
                        <div class="contenedor-input">
                            <input
                                type="number"
                                min="0.1"
                                step="0.1"
                                class="input-dato"
                                name="duracion"
                                placeholder="Ej: 2.5 horas"
                            />
                        </div>
                    </div>

                    <div class="contenedor-dato">
                        <p class="texto-dato">Ubicaci√≥n</p>
                        <div class="contenedor-input">
                            <input
                                type="text"
                                class="input-dato"
                                name="ubicacion"
                                required
                                placeholder="Ej: Aula 101, Laboratorio de Sistemas, etc."
                            />
                        </div>
                    </div>
                </div>

                <div class="contenedor-inferior">
                    <p class="texto-centrado texto-roja">Organizador</p>
                    <div class="contenedor-dato">
                        <p class="texto-dato">Organizador</p>
                        <div class="contenedor-input">
                            <select
                                name="cedula_organizador"
                                class="input-dato"
                                required
                            >
                                <option value=""
                                    >Seleccione un Organizador</option
                                >
                                {
                                    organizadores.map((organizador) => (
                                        <option value={organizador.ced_org}>
                                            {organizador.nom_org1}{" "}
                                            {organizador.nom_org2 || ""}{" "}
                                            {organizador.ape_org1}{" "}
                                            {organizador.ape_org2} -{" "}
                                            {organizador.ced_org}
                                        </option>
                                    ))
                                }
                            </select>
                        </div>
                    </div>
                    <!-- Secci√≥n de Asignaciones -->
                    <div class="contenedor-superior">
                        <p class="texto-centrado texto-roja">Dirigido a</p>
                        <div class="contenedor-dato">
                            <p class="texto-dato">Asignaci√≥n (opcional):</p>
                            <div class="contenedor-input">
                                <select
                                    id="asignacion-evento-nuevo"
                                    name="asignacion_id"
                                    class="input-dato"
                                >
                                    <option value="">
                                        Sin restricciones (abierto a todos)
                                    </option>
                                    <!-- Las opciones se cargar√°n din√°micamente -->
                                </select>
                            </div>
                            <p class="texto-info-asignaciones">
                                Si no seleccionas una asignaci√≥n, el evento
                                estar√° abierto a todos los usuarios sin
                                restricciones de carrera o facultad.
                            </p>
                        </div>
                    </div>
                    <div class="contenedor-imagen">
                        <img
                            id="nueva-evento-imagen"
                            class="imagen-evento"
                            style="display: none;"
                            alt="Imagen del nuevo evento"
                        />
                        <div class="contenedor-file">
                            <label
                                for="file-upload-nuevo"
                                class="custom-file-upload"
                            >
                                <img
                                    src="/img/CRUD/upload.png"
                                    alt="Subir imagen"
                                    class="upload-icon"
                                />
                                <span>Seleccionar imagen</span>
                            </label>
                            <input
                                id="file-upload-nuevo"
                                type="file"
                                name="imagen"
                                class="input-file"
                                accept="image/*"
                            />
                            <p class="file-name">
                                No se ha seleccionado ning√∫n archivo
                            </p>
                        </div>
                    </div>

                    <div class="contenedor-boton-modificar">
                        <button
                            type="button"
                            class="boton-modificar"
                            onclick="cerrarModalNuevoEvento()">Cancelar</button
                        >
                        <button type="submit" class="boton-modificar"
                            >Crear Evento</button
                        >
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .texto-info-asignaciones {
        margin-top: 5px;
        color: #6b7280;
        font-size: 12px;
        font-style: italic;
    }

    .input-dato[name="precio"]:disabled {
        background-color: #f3f4f6;
        color: #6b7280;
    }

    .contenedor-nombre {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .contenedor-dato textarea {
        resize: vertical;
        min-height: 60px;
    }

    .precio-container {
        position: relative;
    }

    .precio-label {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #6b7280;
        pointer-events: none;
    }

    .input-dato[name="precio"] {
        padding-left: 25px;
    }

    /* Estilos para informaci√≥n de categor√≠a */
    .info-categoria-contenido {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 12px;
        margin-top: 8px;
    }

    .info-item {
        margin: 6px 0;
        font-size: 14px;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .info-item strong {
        color: #1f2937;
        min-width: 140px;
    }
    #info-categoria-nuevo {
        border-left: 3px solid #3b82f6;
        padding-left: 12px;
        background-color: #f0f9ff;
        border-radius: 0 6px 6px 0;
    }

    #campos-puntaje-nuevo,
    #campos-asistencia-nuevo {
        border-left: 3px solid #10b981;
        padding-left: 12px;
        background-color: #f0fdf4;
        border-radius: 0 6px 6px 0;
    }

    .categoria-destacada {
        background-color: #eff6ff !important;
        border: 2px solid #3b82f6 !important;
    }
</style>

<script>
    import { actions } from "astro:actions";
    import Swal from "sweetalert2";
    declare global {
        interface Window {
            abrirModalNuevoEvento: () => void;
            cerrarModalNuevoEvento: () => void;
            toggleGratuitoNuevo: (input: HTMLInputElement) => void;
            togglePrecioNuevo: (select: HTMLSelectElement) => void;
            mostrarInfoCategoriaNuevo: (select: HTMLSelectElement) => void;
        }
    }

    let asignacionesDisponibles: any[] = []; // Funci√≥n para mostrar informaci√≥n de categor√≠a
    function mostrarInfoCategoriaNuevo(select: HTMLSelectElement): void {
        console.log("üîç Ejecutando mostrarInfoCategoriaNuevo");
        const selectedOption = select.selectedOptions[0];

        // Elementos de informaci√≥n
        const infoCategoria = document.getElementById(
            "info-categoria-nuevo",
        ) as HTMLElement;
        const infoPuntaje = document.getElementById(
            "info-puntaje-nuevo",
        ) as HTMLElement;
        const infoAsistencia = document.getElementById(
            "info-asistencia-nuevo",
        ) as HTMLElement;
        const infoCertificado = document.getElementById(
            "info-certificado-nuevo",
        ) as HTMLElement;
        const valorPuntaje = document.getElementById(
            "valor-puntaje-nuevo",
        ) as HTMLElement;
        const valorPorcentajeAsistencia = document.getElementById(
            "valor-porcentaje-asistencia-nuevo",
        ) as HTMLElement;

        if (!selectedOption || !selectedOption.value) {
            // Ocultar todo si no hay selecci√≥n
            if (infoCategoria) infoCategoria.style.display = "none";
            return;
        }

        // Obtener datos de la categor√≠a
        const puntajeApr = selectedOption.getAttribute("data-puntaje");
        const porcentajeAsistencia = selectedOption.getAttribute(
            "data-porcentaje-asistencia",
        );
        const requierePuntaje =
            selectedOption.getAttribute("data-requiere-puntaje") === "true";
        const requiereAsistencia =
            selectedOption.getAttribute("data-requiere-asistencia") === "true";
        const brindaCertificado =
            selectedOption.getAttribute("data-brinda-certificado") === "true";

        // Mostrar informaci√≥n de la categor√≠a
        if (infoCategoria) {
            infoCategoria.style.display = "block";

            // Mostrar/ocultar informaci√≥n seg√∫n los atributos
            if (infoPuntaje && valorPuntaje) {
                if (requierePuntaje && puntajeApr) {
                    infoPuntaje.style.display = "block";
                    valorPuntaje.textContent = puntajeApr;
                } else {
                    infoPuntaje.style.display = "none";
                }
            }

            if (infoAsistencia && valorPorcentajeAsistencia) {
                if (requiereAsistencia) {
                    infoAsistencia.style.display = "block";
                    // Mostrar el porcentaje de asistencia si est√° disponible, sino un valor por defecto
                    valorPorcentajeAsistencia.textContent =
                        porcentajeAsistencia || "80";
                } else {
                    infoAsistencia.style.display = "none";
                }
            }

            if (infoCertificado) {
                infoCertificado.style.display = brindaCertificado
                    ? "block"
                    : "none";
            }
        }

        console.log("üìä Informaci√≥n de categor√≠a actualizada:", {
            requierePuntaje,
            requiereAsistencia,
            brindaCertificado,
            puntajeApr,
            porcentajeAsistencia,
        });
    } // Funci√≥n para manejar el toggle de precio gratuito
    function toggleGratuitoNuevo(input: HTMLInputElement): void {
        const esGratuitoSelect = document.querySelector(
            'select[name="es_gratuito-nuevo"]',
        ) as HTMLSelectElement;
        const contenedorPrecio = document.getElementById(
            "contenedor-precio-nuevo",
        ) as HTMLElement;

        if (parseFloat(input.value) === 0) {
            esGratuitoSelect.value = "true";
            input.disabled = true;
            if (contenedorPrecio) contenedorPrecio.style.display = "none";
        } else {
            esGratuitoSelect.value = "false";
            input.disabled = false;
            if (contenedorPrecio) contenedorPrecio.style.display = "block";
        }
    } // Funci√≥n para manejar el toggle desde el select gratuito
    function togglePrecioNuevo(select: HTMLSelectElement): void {
        const precioInput = document.querySelector(
            'input[name="precio"]',
        ) as HTMLInputElement;
        const contenedorPrecio = document.getElementById(
            "contenedor-precio-nuevo",
        ) as HTMLElement;

        if (select.value === "true") {
            // Es gratuito - ocultar precio
            if (contenedorPrecio) contenedorPrecio.style.display = "none";
            if (precioInput) {
                precioInput.value = "0";
                precioInput.disabled = true;
            }
        } else {
            // No es gratuito - mostrar precio
            if (contenedorPrecio) contenedorPrecio.style.display = "block";
            if (precioInput) {
                precioInput.disabled = false;
                if (precioInput.value === "0") {
                    precioInput.value = "";
                }
            }
        }
    } // Cargar asignaciones disponibles
    async function cargarAsignacionesNuevo() {
        try {
            console.log("üîÑ Cargando asignaciones disponibles...");
            const { data, error } = await actions.getAllAsignaciones({});

            if (error) {
                console.error("‚ùå Error al cargar asignaciones:", error);
                return;
            }

            if (!data?.success || !data.asignaciones) {
                console.warn("‚ö†Ô∏è No hay asignaciones disponibles");
                return;
            }
            asignacionesDisponibles = data.asignaciones;
            const select = document.getElementById(
                "asignacion-evento-nuevo",
            ) as HTMLSelectElement;

            if (!select) {
                console.error(
                    "‚ùå No se encontr√≥ el elemento select #asignacion-evento-nuevo",
                );
                return;
            }

            // Limpiar opciones existentes (excepto la primera)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild!);
            }

            // Agregar asignaciones disponibles
            asignacionesDisponibles.forEach((asignacion) => {
                const option = document.createElement("option");
                option.value = asignacion.id_asi;

                // Mostrar informaci√≥n de la asignaci√≥n
                let descripcion = asignacion.nom_asi;
                if (asignacion.tip_asi) {
                    descripcion += ` (${asignacion.tip_asi})`;
                }

                option.textContent = descripcion;
                select.appendChild(option);
            });

            console.log(
                "‚úÖ Asignaciones cargadas:",
                asignacionesDisponibles.length,
            );
        } catch (error) {
            console.error("üí• Error cr√≠tico al cargar asignaciones:", error);
        }
    }

    function ajustarFecha(fechaString: string, dias: number): string {
        if (!fechaString) return "";
        const fecha = new Date(fechaString + "T00:00:00");
        fecha.setDate(fecha.getDate() + dias);
        return fecha.toISOString().split("T")[0];
    }

    function actualizarValidacionFechas() {
        const fechaInicioInscripcionesInput = document.getElementById(
            "fecha_inicio_inscripciones_nuevo",
        ) as HTMLInputElement;
        const fechaFinInscripcionesInput = document.getElementById(
            "fecha_fin_inscripciones_nuevo",
        ) as HTMLInputElement;
        const fechaInicioEventoInput = document.getElementById(
            "fecha_inicio_nuevo",
        ) as HTMLInputElement;
        const fechaFinEventoInput = document.getElementById(
            "fecha_fin_nuevo",
        ) as HTMLInputElement;

        const fechaInicioInscripciones = fechaInicioInscripcionesInput.value;
        const fechaFinInscripciones = fechaFinInscripcionesInput.value;
        const fechaInicioEvento = fechaInicioEventoInput.value;
        const fechaFinEvento = fechaFinEventoInput.value;

        // 1. Fin de inscripciones: m√≠nimo 1 d√≠a despu√©s de inicio de inscripciones
        if (fechaInicioInscripciones) {
            fechaFinInscripcionesInput.min = ajustarFecha(
                fechaInicioInscripciones,
                1,
            );
        } else {
            fechaFinInscripcionesInput.min = "";
        }

        // 2. Inicio de evento: m√≠nimo 2 d√≠as despu√©s de inicio de inscripciones
        if (fechaInicioInscripciones) {
            fechaInicioEventoInput.min = ajustarFecha(
                fechaInicioInscripciones,
                2,
            );
        } else {
            fechaInicioEventoInput.min = "";
        }

        // 3. Fin de inscripciones: m√°ximo 1 d√≠a antes del inicio del evento
        if (fechaInicioEvento) {
            fechaFinInscripcionesInput.max = ajustarFecha(
                fechaInicioEvento,
                -1,
            );
        } else {
            fechaFinInscripcionesInput.max = "";
        }

        // 4. Inicio de evento: m√≠nimo 1 d√≠a despu√©s del fin de inscripciones
        if (fechaFinInscripciones) {
            const minPorFinInscripciones = ajustarFecha(
                fechaFinInscripciones,
                1,
            );
            if (
                !fechaInicioEventoInput.min ||
                minPorFinInscripciones > fechaInicioEventoInput.min
            ) {
                fechaInicioEventoInput.min = minPorFinInscripciones;
            }
        }

        // 5. Inicio de evento: m√°ximo igual a la fecha de fin de evento
        if (fechaFinEvento) {
            fechaInicioEventoInput.max = ajustarFecha(fechaFinEvento, -1);
        } else {
            fechaInicioEventoInput.max = "";
        }

        // 6. Fin de evento: m√≠nimo 1 d√≠a despu√©s del inicio del evento
        if (fechaInicioEvento) {
            fechaFinEventoInput.min = ajustarFecha(fechaInicioEvento, 1);
        } else {
            fechaFinEventoInput.min = "";
        }

        // 7. Inicio de evento: no puede ser inferior a la de fin de inscripciones
        if (fechaFinInscripciones) {
            const minPorFinInscripciones = ajustarFecha(
                fechaFinInscripciones,
                1,
            );
            if (
                !fechaInicioEventoInput.min ||
                minPorFinInscripciones > fechaInicioEventoInput.min
            ) {
                fechaInicioEventoInput.min = minPorFinInscripciones;
            }
        }

        // Control visual para inicio de inscripciones
        if (fechaInicioEvento) {
            fechaInicioInscripcionesInput.max = ajustarFecha(fechaInicioEvento, -2);
        } else {
            fechaInicioInscripcionesInput.max = "";
        }

        // Control visual para fin de evento
        if (fechaInicioInscripciones) {
            fechaFinEventoInput.min = ajustarFecha(fechaInicioInscripciones, 3);
        } else {
            fechaFinEventoInput.min = "";
        }

        // Control visual: inicio de inscripciones debe ser al menos 1 d√≠a antes que fin de inscripciones
        if (fechaFinInscripciones) {
            fechaInicioInscripcionesInput.max = ajustarFecha(fechaFinInscripciones, -1);
        } else {
            // Si no hay fin de inscripciones, quitar restricci√≥n
            fechaInicioInscripcionesInput.max = "";
        }

        // Control visual: fin de evento debe ser m√≠nimo 1 d√≠a despu√©s del inicio de evento
        if (fechaInicioEvento) {
            // Si ya hay un min por inscripciones, usamos el mayor de ambos
            const minPorInicioEvento = ajustarFecha(fechaInicioEvento, 1);
            if (
                !fechaFinEventoInput.min ||
                new Date(minPorInicioEvento) > new Date(fechaFinEventoInput.min)
            ) {
                fechaFinEventoInput.min = minPorInicioEvento;
            }
        }

        // Control visual: fin de evento debe ser m√≠nimo 2 d√≠as despu√©s del fin de inscripciones
        if (fechaFinInscripciones) {
            const minPorFinInscripciones = ajustarFecha(fechaFinInscripciones, 2);
            if (
                !fechaFinEventoInput.min ||
                new Date(minPorFinInscripciones) > new Date(fechaFinEventoInput.min)
            ) {
                fechaFinEventoInput.min = minPorFinInscripciones;
            }
        }
    }

    function abrirModalNuevoEvento(): void {
        console.log("üéØ Abriendo modal nuevo evento...");
        const modal = document.getElementById("modalNuevoEvento");
        if (modal) {
            modal.style.display = "block";

            // Establecer fechas por defecto
            const fechaHoy = new Date().toISOString().split("T")[0];
            const fechaInscripcionInicio = document.querySelector(
                'input[name="fecha_inicio_inscripciones"]',
            ) as HTMLInputElement;
            const fechaEvento = document.querySelector(
                'input[name="fecha_inicio"]',
            ) as HTMLInputElement;

            if (fechaInscripcionInicio && !fechaInscripcionInicio.value) {
                fechaInscripcionInicio.value = fechaHoy;
                actualizarValidacionFechas(); // <-- ¬°Agrega esto aqu√≠!
            }

            console.log("üîÑ Intentando cargar asignaciones...");
            // Cargar asignaciones
            cargarAsignacionesNuevo();
        } else {
            console.error("‚ùå No se encontr√≥ el modal #modalNuevoEvento");
        }
    }
    function cerrarModalNuevoEvento(): void {
        const modal = document.getElementById("modalNuevoEvento");
        const form = document.getElementById(
            "formulario-nuevo-evento",
        ) as HTMLFormElement;

        if (modal && form) {
            modal.style.display = "none";
            form.reset();

            // Resetear imagen
            const imagen = document.getElementById(
                "nueva-evento-imagen",
            ) as HTMLImageElement;
            const fileName = document.querySelector(
                "#modalNuevoEvento .file-name",
            ) as HTMLElement;
            if (imagen) imagen.style.display = "none";
            if (fileName)
                fileName.textContent = "No se ha seleccionado ning√∫n archivo";

            // Resetear precio y su contenedor
            const precioInput = document.querySelector(
                'input[name="precio"]',
            ) as HTMLInputElement;
            const contenedorPrecio = document.getElementById(
                "contenedor-precio-nuevo",
            ) as HTMLElement;
            if (precioInput) {
                precioInput.disabled = false;
                precioInput.value = "0";
            }
            if (contenedorPrecio) {
                contenedorPrecio.style.display = "none";
            } // Resetear informaci√≥n de categor√≠a
            const infoCategoria = document.getElementById(
                "info-categoria-nuevo",
            ) as HTMLElement;

            if (infoCategoria) infoCategoria.style.display = "none";
        }
    } // Asignar funciones al objeto window
    window.abrirModalNuevoEvento = abrirModalNuevoEvento;
    window.cerrarModalNuevoEvento = cerrarModalNuevoEvento;
    window.toggleGratuitoNuevo = toggleGratuitoNuevo;
    window.togglePrecioNuevo = togglePrecioNuevo;
    window.mostrarInfoCategoriaNuevo = mostrarInfoCategoriaNuevo;

    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById(
            "formulario-nuevo-evento",
        ) as HTMLFormElement;
        const fileInput = document.getElementById(
            "file-upload-nuevo",
        ) as HTMLInputElement;
        const fileNameDisplay = document.querySelector(
            "#modalNuevoEvento .file-name",
        ) as HTMLElement;
        const nuevaEventoImagen = document.getElementById(
            "nueva-evento-imagen",
        ) as HTMLImageElement;

        const fechaInicioInscripcionesInput = document.getElementById(
            "fecha_inicio_inscripciones_nuevo",
        ) as HTMLInputElement;
        const fechaFinInscripcionesInput = document.getElementById(
            "fecha_fin_inscripciones_nuevo",
        ) as HTMLInputElement;
        const fechaInicioEventoInput = document.getElementById(
            "fecha_inicio_nuevo",
        ) as HTMLInputElement;
        const fechaFinEventoInput = document.getElementById(
            "fecha_fin_nuevo",
        ) as HTMLInputElement;

        fechaInicioInscripcionesInput.addEventListener(
            "change",
            actualizarValidacionFechas,
        );
        fechaFinInscripcionesInput.addEventListener(
            "change",
            actualizarValidacionFechas,
        );
        fechaInicioEventoInput.addEventListener(
            "change",
            actualizarValidacionFechas,
        );
        fechaFinEventoInput.addEventListener(
            "change",
            actualizarValidacionFechas,
        );

        // Manejar cambio de archivo
        if (fileInput && fileNameDisplay && nuevaEventoImagen) {
            fileInput.addEventListener("change", (e: Event) => {
                const target = e.target as HTMLInputElement;
                const file = target.files?.[0];

                if (file && file.type.match("image.*")) {
                    fileNameDisplay.textContent = file.name;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        if (event.target?.result) {
                            nuevaEventoImagen.src = event.target
                                .result as string;
                            nuevaEventoImagen.style.display = "block";
                        }
                    };
                    reader.readAsDataURL(file);
                } else {
                    fileNameDisplay.textContent =
                        "No se ha seleccionado ning√∫n archivo v√°lido";
                    nuevaEventoImagen.style.display = "none";
                }
            });
        }

        // Manejar env√≠o del formulario
        if (form) {
            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const formData = new FormData(form);

                // Obtener fechas desde los inputs
                const fechaInicioInscripciones =
                    (formData.get("fecha_inicio_inscripciones") as string) ||
                    "";
                const fechaFinInscripciones =
                    (formData.get("fecha_fin_inscripciones") as string) || "";
                const fechaInicioEvento =
                    (formData.get("fecha_inicio") as string) || "";
                const fechaFinEvento =
                    (formData.get("fecha_fin") as string) || "";

                // Validar que todas las fechas requeridas existan antes de comparar
                if (
                    !fechaInicioInscripciones ||
                    !fechaFinInscripciones ||
                    !fechaInicioEvento ||
                    !fechaFinEvento
                ) {
                    await Swal.fire({
                        icon: "error",
                        title: "Error en fechas",
                        text: "Debes completar todas las fechas requeridas.",
                        confirmButtonColor: "#dc2626",
                    });
                    return;
                }

                // 1. Fin de inscripciones: m√≠nimo 1 d√≠a despu√©s de inicio de inscripciones
                if (
                    new Date(fechaFinInscripciones) <
                    new Date(ajustarFecha(fechaInicioInscripciones, 1))
                ) {
                    await Swal.fire({
                        icon: "error",
                        title: "Error en fechas de inscripci√≥n",
                        text: "La fecha de fin de inscripciones debe ser al menos 1 d√≠a despu√©s del inicio.",
                        confirmButtonColor: "#dc2626",
                    });
                    return;
                }

                // 2. Inicio de evento: m√≠nimo 2 d√≠as despu√©s del inicio de inscripciones
                if (
                    new Date(fechaInicioEvento) <
                    new Date(ajustarFecha(fechaInicioInscripciones, 2))
                ) {
                    await Swal.fire({
                        icon: "error",
                        title: "Error en fechas",
                        text: "El evento debe iniciar al menos 2 d√≠as despu√©s del inicio de inscripciones.",
                        confirmButtonColor: "#dc2626",
                    });
                    return;
                }

                // 3. Fin de inscripciones: m√°ximo 1 d√≠a antes del inicio del evento
                if (
                    new Date(fechaFinInscripciones) >
                    new Date(ajustarFecha(fechaInicioEvento, -1))
                ) {
                    await Swal.fire({
                        icon: "error",
                        title: "Error en fechas de inscripci√≥n",
                        text: "La fecha de fin de inscripciones debe ser m√°ximo 1 d√≠a antes del inicio del evento.",
                        confirmButtonColor: "#dc2626",
                    });
                    return;
                }

                // 4. Inicio de evento: m√≠nimo 1 d√≠a despu√©s del fin de inscripciones
                if (
                    new Date(fechaInicioEvento) <
                    new Date(ajustarFecha(fechaFinInscripciones, 1))
                ) {
                    await Swal.fire({
                        icon: "error",
                        title: "Error en fechas",
                        text: "El evento debe iniciar al menos 1 d√≠a despu√©s de finalizar las inscripciones.",
                        confirmButtonColor: "#dc2626",
                    });
                    return;
                }

                // 5. Inicio de evento: m√°ximo igual a la fecha de fin de evento
                if (new Date(fechaInicioEvento) > new Date(fechaFinEvento)) {
                    await Swal.fire({
                        icon: "error",
                        title: "Error en fechas",
                        text: "La fecha de inicio del evento no puede ser posterior a la fecha de fin del evento.",
                        confirmButtonColor: "#dc2626",
                    });
                    return;
                }

                // 6. Fin de evento: m√≠nimo 1 d√≠a despu√©s del inicio del evento
                if (
                    new Date(fechaFinEvento) <
                    new Date(ajustarFecha(fechaInicioEvento, 1))
                ) {
                    await Swal.fire({
                        icon: "error",
                        title: "Error en fechas",
                        text: "La fecha de fin de evento debe ser al menos 1 d√≠a despu√©s del inicio del evento.",
                        confirmButtonColor: "#dc2626",
                    });
                    return;
                }

                // 7. Inicio de evento: no puede ser inferior a la de fin de inscripciones
                if (fechaFinInscripciones) {
                    const minPorFinInscripciones = ajustarFecha(
                        fechaFinInscripciones,
                        1,
                    );
                    if (
                        !fechaInicioEventoInput.min ||
                        minPorFinInscripciones > fechaInicioEventoInput.min
                    ) {
                        fechaInicioEventoInput.min = minPorFinInscripciones;
                    }
                }

                // Control visual para inicio de inscripciones
                if (fechaInicioEvento) {
                    fechaInicioInscripcionesInput.max = ajustarFecha(fechaInicioEvento, -2);
                } else {
                    fechaInicioInscripcionesInput.max = "";
                }

                // Control visual para fin de evento
                if (fechaInicioInscripciones) {
                    fechaFinEventoInput.min = ajustarFecha(fechaInicioInscripciones, 3);
                } else {
                    fechaFinEventoInput.min = "";
                }

                // Control visual: inicio de inscripciones debe ser al menos 1 d√≠a antes que fin de inscripciones
                if (fechaFinInscripciones) {
                    fechaInicioInscripcionesInput.max = ajustarFecha(fechaFinInscripciones, -1);
                } else {
                    // Si no hay fin de inscripciones, quitar restricci√≥n
                    fechaInicioInscripcionesInput.max = "";
                }

                // Control visual: fin de evento debe ser m√≠nimo 1 d√≠a despu√©s del inicio de evento
                if (fechaInicioEvento) {
                    // Si ya hay un min por inscripciones, usamos el mayor de ambos
                    const minPorInicioEvento = ajustarFecha(fechaInicioEvento, 1);
                    if (
                        !fechaFinEventoInput.min ||
                        new Date(minPorInicioEvento) > new Date(fechaFinEventoInput.min)
                    ) {
                        fechaFinEventoInput.min = minPorInicioEvento;
                    }
                }

                // Control visual: fin de evento debe ser m√≠nimo 2 d√≠as despu√©s del fin de inscripciones
                if (fechaFinInscripciones) {
                    const minPorFinInscripciones = ajustarFecha(fechaFinInscripciones, 2);
                    if (
                        !fechaFinEventoInput.min ||
                        new Date(minPorFinInscripciones) > new Date(fechaFinEventoInput.min)
                    ) {
                        fechaFinEventoInput.min = minPorFinInscripciones;
                    }
                }

                try {
                    const { data, error } = await actions.crearEvento(formData);

                    if (data?.success) {
                        await Swal.fire({
                            icon: "success",
                            title: "¬°√âxito!",
                            text: "Evento creado correctamente",
                            confirmButtonColor: "#059669",
                        }).then(() => {
                            window.location.reload();
                        });
                    } else {
                        await Swal.fire({
                            icon: "error",
                            title: "Error",
                            text:
                                data?.message ||
                                error?.message ||
                                "No se pudo crear el evento",
                            confirmButtonColor: "#dc2626",
                        });
                    }
                } catch (error) {
                    console.error("Error:", error);
                    await Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: "Error al procesar la solicitud",
                        confirmButtonColor: "#dc2626",
                    });
                }
            });
        }
    });
</script>
