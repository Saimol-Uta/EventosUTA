---
import "../../../styles/Admin/ModalDetallesEvento.css";
import ModalDetallesCuenta from "../UsuariosCRUD/ModalDetallesCuenta.astro";
---

<div id="modalDetallesUsuario" class="modal">
    <ModalDetallesCuenta />
    <div class="modal-contenido">
        <span class="cerrar" onclick="cerrarModalDetallesUsuario()">&times;</span>
        <div class="detalles-reserva">
            <h2 id="usuario-nombre">Nombre del Usuario</h2>

            <div class="seccion-detalles">
                <h3>Información General</h3>
                <div class="info-grid">
                    <p>
                        <strong>Cédula:</strong>
                        <span id="usuario-cedula"></span>
                    </p>
                    <p><strong>Fecha de Nacimiento:</strong> <span id="usuario-fec-nac"></span></p>
                </div>
            </div>

            <div class="seccion-detalles">
                <div class="info-grid">
                <p><strong>Número de Teléfono:</strong> <span id="usuario-numero"></span></p>
                <p><strong>Carrera:</strong> <span id="usuario-carrera"></span></p>
                </div>
            </div>

            <div class="seccion-detalles">
                    <p class="texto-centrado texto-roja">Cuentas Asociadas</p>

                    <div class="contenedor-dato">
                        <div id="usuario-cuentas" class="asignaciones-display">
                        <!-- Aquí se mostrará dinámicamente la lista de cuentas asociadas -->
                        </div>
                    </div>

                    <div class="contenedor-dato">
                        <div class="contenedor-botones-asignaciones">
                            <button
                            type="button"
                            class="boton-asignacion btn-gestionar"
                            onclick="abrirModalDetallesCuenta('correo@ejemplo.com', 'estudiante')"
                            >
                            Mostrar Información de Cuenta
                            </button>
                        </div>
                    </div>

            </div>
        </div>
    </div>
</div>

<script>
    declare global {
        interface Window {
            cerrarModalDetallesUsuario: () => void;
            abrirModalDetallesUsuario: (evento: any) => void;
        }
    }

    function cerrarModalDetallesUsuario() {
        const modal = document.getElementById("modalDetallesUsuario");
        if (modal) modal.style.display = "none";
    }

    function abrirModalDetallesUsuario(evento: any) {
        const modal = document.getElementById("modalDetallesUsuario");
        if (!modal) return;

        // Poblar el modal con los datos del evento
        poblarModalConDatos(evento);

        modal.style.display = "block";
    }

    function poblarModalConDatos(evento: any) {
        const modal = document.getElementById("modalDetallesUsuario");
        if (!modal) return;

        // Actualizar título del modal
        const titulo = modal.querySelector("#evento-nombre");
        if (titulo) titulo.textContent = evento.nom_eve || "Sin nombre";

        // Información General
        const categoria = modal.querySelector("#evento-categoria");
        if (categoria) {
            // Manejar tanto evento.categoria.data como evento.categoria directamente
            const categoriaData = evento.categoria?.data || evento.categoria;
            categoria.textContent = categoriaData?.nom_cat || "Sin categoría";
        }

        const area = modal.querySelector("#evento-area");
        if (area) area.textContent = evento.are_eve || "No especificada";

        const precio = modal.querySelector("#evento-precio");
        if (precio) precio.textContent = `$${evento.precio || 0}`;

        // Organizador - Cédula
        const organizadorCedula = modal.querySelector("#organizador-cedula");
        if (organizadorCedula) {
            const orgData = evento.organizador?.data || evento.organizador;
            organizadorCedula.textContent =
                orgData?.ced_org || "No especificada";
        }

        // Organizador - Nombre
        const organizadorNombre = modal.querySelector("#organizador-nombre");
        if (organizadorNombre) {
            const orgData = evento.organizador?.data || evento.organizador;
            if (orgData) {
                const nombreCompleto =
                    `${orgData.nom_org1} ${orgData.nom_org2 || ""} ${orgData.ape_org1} ${orgData.ape_org2 || ""}`.trim();
                organizadorNombre.textContent = nombreCompleto;
            } else {
                organizadorNombre.textContent = "No especificado";
            }
        } 
        
        // Organizador - Título
        const organizadorTitulo = modal.querySelector("#organizador-titulo");
        if (organizadorTitulo) {
            const orgData = evento.organizador?.data || evento.organizador;
            organizadorTitulo.textContent =
                orgData?.tit_aca_org || "No especificado";
        }

        // Configuración del Evento - Nota de Aprobación
        const notaAprobacion = modal.querySelector("#evento-nota-aprobacion");
        if (notaAprobacion) {
            notaAprobacion.textContent =
                (evento.not_apr_eve || 7.0).toString() + " puntos";
        }

        // Configuración del Evento - Tiempo de Registro
        const tiempoRegistro = modal.querySelector("#evento-tiempo-registro");
        if (tiempoRegistro) {
            tiempoRegistro.textContent =
                evento.tie_reg_asi !== false
                    ? "Permitir registro en cualquier momento"
                    : "Restringir tiempo de registro";
        }
    } // Cerrar modal al hacer clic fuera de él
    window.onclick = function (event) {
        const modal = document.getElementById("modalDetallesUsuario");
        if (event.target === modal) {
            cerrarModalDetallesUsuario();
        }
    }; // Exponer funciones globalmente
    window.cerrarModalDetallesUsuario = cerrarModalDetallesUsuario;
    window.abrirModalDetallesUsuario = abrirModalDetallesUsuario;
</script>
