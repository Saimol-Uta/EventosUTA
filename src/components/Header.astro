---
import HeaderUsuario from "@components/HeaderUsuario.astro";
import Navbar from "./Navbar.astro";
import { actions } from "astro:actions";
import { getSession } from "auth-astro/server";

const imagenLogo = "/img/logoFisei.png";
const titulo1 = "FACULTAD DE INGENIERÍA";
const titulo2 = "EN SISTEMAS, ELECTRÓNICA E INDUSTRIAL";

const session = await getSession(Astro.request);

const { data: cuenta } = await Astro.callAction(
  actions.getCuentaByIdSingle,
  session?.user?.id || ""
);

const { isMaster, isStudent, isUser, isAdmin, isLoggedIn } = Astro.locals;

const nombreCompleto = (
  `${cuenta?.nom_usu1 || ""} ${cuenta?.nom_usu2 || ""} ${cuenta?.ape_usu1 || ""} ${cuenta?.ape_usu2 || ""}`
).trim() || "Usuario";

const imagenPerfil = cuenta?.img_user || "/PerfilDefault.png";
---

<!-- Zona invisible para activar header + navbar -->
<div class="hover-zone"></div>

<!-- Contenedor Header + Navbar -->
<div id="headerNavbar" class="header-navbar-wrapper">
  {(isMaster || isStudent || isUser || isAdmin || isLoggedIn) ? (
    <HeaderUsuario
      nombreUsuario={nombreCompleto}
      userImage={imagenPerfil}
      logoImage={imagenLogo}
      titulo1={titulo1}
      titulo2={titulo2}
    />
  ) : (
    <header class="flex flex-wrap items-center justify-between px-8 py-2 border-b border-gray-300 bg-white z-20">
      <div class="flex items-center gap-3 min-w-[250px]">
        <a href="/" class="flex items-center gap-2">
          <img src={imagenLogo} alt="Logo" class="w-16 h-auto" />
          <div class="flex flex-col leading-tight">
            <span class="text-sm font-semibold text-red-800">{titulo1}</span>
            <span class="text-xs font-semibold text-red-800">{titulo2}</span>
          </div>
        </a>
      </div>

      <div class="flex flex-wrap items-center justify-end gap-8 min-w-[250px]">
        <a href="/buscarCertificado" class="text-[#660000] hover:text-[#a00000] transition-colors flex gap-2 items-center">
          <svg class="w-6 h-6 fill-[#ad272e] -scale-y-100" viewBox="0 0 1710 1770"><!-- icono --></svg>
          <span class="font-medium text-sm">Verifica tu certificado</span>
        </a>
        <a href="/login" class="text-[#660000] hover:text-[#a00000] transition-colors flex gap-2 items-center">
          <svg class="w-6 h-6 fill-[#ad272e] -scale-y-100" viewBox="0 0 1920 1740"><!-- icono --></svg>
          <span class="font-medium text-sm">Inicia sesión</span>
        </a>
      </div>
    </header>
  )}

  <!-- Navbar incluido -->
  <Navbar navbarInHeader={true} />
</div>

<style>
  .hover-zone {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 40px;
    z-index: 1000;
  }

  .header-navbar-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    transform: translateY(0);
    transition: transform 0.3s ease;
    z-index: 999;
  }

  body.with-header-space {
    padding-top: 132px; /* Ajusta según la altura del header + navbar */
  }

  body.scrolled .header-navbar-wrapper {
    transform: translateY(-100%);
  }

  .hover-zone:hover + .header-navbar-wrapper,
  .header-navbar-wrapper:hover {
    transform: translateY(0) !important;
  }
</style>

<script>
  if (typeof window !== 'undefined') {
    const setScrollClass = () => {
      if (window.scrollY === 0) {
        document.body.classList.remove('scrolled');
      } else {
        document.body.classList.add('scrolled');
      }
      if (!document.body.classList.contains('with-header-space')) {
        document.body.classList.add('with-header-space');
      }
    };

    window.addEventListener('scroll', setScrollClass);
    window.addEventListener('load', setScrollClass);
  }
</script>
