---
import "../styles/ModalDetallesInscripcion.css";
---

<div id="modalDetallesPago" class="modal">
    <div class="modal-contenido">
        <span class="cerrar" onclick="cerrarModalPagoInscripcion()"
            >&times;</span
        >
        <div class="detalles-reserva">
            <h2>Nombre del Evento</h2>

            <div class="seccion-detalles">
                <h3>Información del Usuario</h3>
                <div class="descripcion-completa-container">
                    <p>
                        <strong>Nombres:</strong>
                        <span id="usuario-nombres"></span>
                    </p>
                    <p>
                        <strong>Apellidos:</strong>
                        <span id="usuario-apellidos"></span>
                    </p>
                    <p>
                        <strong>Correo:</strong>
                        <span id="usuario-correo"></span>
                    </p>
                    <p>
                        <strong>Cédula:</strong>
                        <span id="usuario-cedula"></span>
                    </p>
                </div>
            </div>
            <div class="seccion-detalles">
                <h3>Documentación</h3>
                <div class="info-grid">
                    <p class="centrar campo-factura">
                        <strong>Factura o Comprobante de Pago:</strong>
                        <a
                            href="#"
                            id="enlace-comprobante-pago"
                            target="_blank"
                            style="display: none;">Ver comprobante</a
                        >
                        <span id="sin-comprobante" style="color: #dc2626;"
                            >No disponible</span
                        >
                    </p>
                </div>
            </div>
            <div class="contenedor-boton-modificar">
                <button
                    class="boton-modificar bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded mr-2 transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed"
                    id="boton-aprobar-pago"
                    disabled
                    onclick="if (!this.disabled) aprobarInscripcionPago()">Aprobar</button
                >
                <button
                    class="boton-modificar"
                    onclick="rechazarInscripcionPago()">Rechazar</button
                >
            </div>
        </div>
        <script>
            declare global {
                interface Window {
                    cerrarModalPagoInscripcion: () => void;
                    abrirModalPagoInscripcion: (inscripcionId: string) => void;
                    aprobarInscripcionPago: () => void;
                    rechazarInscripcionPago: () => void;
                    aprobarInscripcion: (
                        inscripcionId: string,
                        tipo: "documentacion" | "pago",
                    ) => Promise<void>;
                    rechazarInscripcion: (
                        inscripcionId: string,
                        tipo: "documentacion" | "pago",
                    ) => Promise<void>;
                    currentInscripcionIdPago: string;
                }
            }
            let currentInscripcionIdPago = "";

            function cerrarModalPagoInscripcion() {
                const modal = document.getElementById("modalDetallesPago");
                if (modal) modal.style.display = "none";
            }
            function abrirModalPagoInscripcion(inscripcionId: string) {
                const modal = document.getElementById("modalDetallesPago");
                if (modal) modal.style.display = "block";
                currentInscripcionIdPago = inscripcionId;
                window.currentInscripcionIdPago = inscripcionId;

                console.log(
                    "Abriendo modal deSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS pago para inscripción:",
                    inscripcionId,
                );

                // Cargar comprobante de pago dinámicamente
                cargarComprobantePago(inscripcionId);
                // Verificar requisitos y actualizar botón
                verificarRequisitosPagoYActualizarBoton();
            }

            function verificarRequisitosPagoYActualizarBoton() {
                const botonAprobar = document.getElementById(
                    "boton-aprobar-pago",
                ) as HTMLButtonElement;

                if (!botonAprobar) return;

                // Deshabilitar por defecto
                botonAprobar.disabled = true;

                const inscripcionesData =
                    (window as any).inscripcionesData || [];
                const inscripcion = inscripcionesData.find(
                    (ins: any) =>
                        ins.id_ins === window.currentInscripcionIdPago,
                );

                if (!inscripcion) {
                    console.warn("No se encontró la inscripción actual");
                    return;
                }

                const evento = inscripcion.eventos || {};

                // Verificar si el evento es de pago
                const esPago =
                    !evento.es_gratuito &&
                    evento.precio &&
                    Number(evento.precio) > 0;

                if (!esPago) {
                    // Si el evento es gratuito, habilitar el botón
                    botonAprobar.disabled = false;
                    botonAprobar.title =
                        "Evento gratuito - No requiere comprobante de pago";
                    return;
                }

                // Si es evento de pago, verificar que existe el comprobante
                const tieneComprobante = isValidDocumentLink(
                    inscripcion.enl_ord_pag_ins,
                );
                console.log(inscripcion.enl_ord_pag_ins, tieneComprobante);

                botonAprobar.disabled = !tieneComprobante;

                if (!tieneComprobante) {
                    botonAprobar.title = `Evento de pago ($${Number(evento.precio).toFixed(2)}) - Falta comprobante de pago`;
                } else {
                    botonAprobar.title = `Evento de pago ($${Number(evento.precio).toFixed(2)}) - Comprobante disponible`;
                }
            }

            function cargarComprobantePago(inscripcionId: string) {
                try {
                    // Obtener datos de inscripción desde el contexto global
                    const inscripcionesData =
                        (window as any).inscripcionesData || [];
                    const inscripcion = inscripcionesData.find(
                        (ins: any) => ins.id_ins === inscripcionId,
                    );

                    if (!inscripcion) {
                        console.warn(
                            "No se encontraron datos de inscripción:",
                            inscripcionId,
                        );
                        mostrarComprobanteNoDisponible();
                        return;
                    }

                    // Referencias a elementos DOM
                    const enlaceComprobante = document.getElementById(
                        "enlace-comprobante-pago",
                    ) as HTMLAnchorElement;
                    const sinComprobante = document.getElementById(
                        "sin-comprobante",
                    ) as HTMLSpanElement;

                    // Configurar enlace del comprobante de pago
                    if (isValidDocumentLink(inscripcion.enl_ord_pag_ins)) {
                        enlaceComprobante.href = inscripcion.enl_ord_pag_ins;
                        enlaceComprobante.style.display = "inline";
                        sinComprobante.style.display = "none";
                    } else {
                        enlaceComprobante.style.display = "none";
                        sinComprobante.style.display = "inline";
                    }
                } catch (error) {
                    console.error(
                        "Error al cargar comprobante de pago:",
                        error,
                    );
                    mostrarComprobanteNoDisponible();
                }
            }

            function isValidDocumentLink(
                link: string | null | undefined,
            ): boolean {
                return (
                    link !== null &&
                    link !== undefined &&
                    link.trim() !== "" &&
                    link !== "null"
                );
            }

            function mostrarComprobanteNoDisponible() {
                const enlaceComprobante = document.getElementById(
                    "enlace-comprobante-pago",
                );
                const sinComprobante =
                    document.getElementById("sin-comprobante");

                if (enlaceComprobante) enlaceComprobante.style.display = "none";
                if (sinComprobante) sinComprobante.style.display = "inline";
            }
            function aprobarInscripcionPago() {
                if (
                    window.aprobarInscripcion &&
                    window.currentInscripcionIdPago
                ) {
                    window.aprobarInscripcion(
                        window.currentInscripcionIdPago,
                        "pago",
                    );
                    cerrarModalPagoInscripcion();
                }
            }

            function rechazarInscripcionPago() {
                if (
                    window.rechazarInscripcion &&
                    window.currentInscripcionIdPago
                ) {
                    window.rechazarInscripcion(
                        window.currentInscripcionIdPago,
                        "pago",
                    );
                    cerrarModalPagoInscripcion();
                }
            }

            window.onclick = function (event) {
                const modal = document.getElementById("modalDetallesPago");
                if (event.target === modal) cerrarModalPagoInscripcion();
            };

            window.cerrarModalPagoInscripcion = cerrarModalPagoInscripcion;
            window.abrirModalPagoInscripcion = abrirModalPagoInscripcion;
            window.aprobarInscripcionPago = aprobarInscripcionPago;
            window.rechazarInscripcionPago = rechazarInscripcionPago;
        </script>
    </div>
</div>
