---
import "../../styles/Inscripcion.css";
import { actions } from "astro:actions";

interface CampoProps {
  usuario: any;
  evento: any;
  requisitos: any[];
  inscripcion?: any;
}

const { usuario, evento, requisitos } = Astro.props as CampoProps;

const usuarioPlano = {
  id_usu: usuario?.id_usu,
  nom_usu1: usuario?.nom_usu1,
  ape_usu1: usuario?.ape_usu1,
  ced_usu: usuario?.ced_usu,
  cuentas: usuario?.cuentas?.map((c: { cor_cue: string, id_cue: string }) => ({ cor_cue: c.cor_cue, id_cue: c.id_cue }))
};

const eventoPlano = {
  id_eve: evento?.id_eve,
  precio: evento?.precio
};

const requisitosCompletos = Array.isArray(requisitos) && requisitos.length > 0;
const datosUsuarioCompletos = usuario?.nom_usu1 && usuario?.ape_usu1 && usuario?.ced_usu;
const esPagado = Number(evento?.precio ?? 0) > 0;

// Inicialización
let inscripcion = null;
let inscripcionResult = null;
let inscripcionError = null;

const idUsuarioBusqueda = usuario?.cuentas?.[0]?.id_cue || usuario?.id_usu || "";
const idEventoBusqueda = evento?.id_eve || "";

// Procesamiento del POST
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const idUsuario = formData.get("idUsuario") ?? "";
  const idEvento = formData.get("idEvento") ?? "";
  const metodoPago = formData.get("metodoPago") ?? "";

  try {
    const params = {
      idUsuario: typeof idUsuario === "string" ? idUsuario : String(idUsuario),
      idEvento: typeof idEvento === "string" ? idEvento : String(idEvento),
      metodoPago: typeof metodoPago === "string" ? metodoPago : String(metodoPago),
    };
    const { data, error } = await Astro.callAction(actions.setDatosInscripcion, params);
    inscripcionResult = data;
    inscripcionError = error;
  } catch (err) {
    inscripcionError = { message: (err && typeof err === "object" && "message" in err) ? err.message : "Error inesperado al inscribir." };
  }
}

// Verificar si ya está inscrito correctamente (corregido)
let yaInscrito = false;
if (idUsuarioBusqueda && idEventoBusqueda) {
  const { data } = await Astro.callAction(actions.getDatosInscripcion, {
    idUsuario: idUsuarioBusqueda,
    idEvento: idEventoBusqueda,
  });
  yaInscrito = Boolean(data?.data?.inscripcion?.id_ins); // Esta es la validación correcta
}
---

{inscripcionResult && (
  <div style="color: green; font-weight: bold; margin: 1rem 0;">
    Inscripción realizada correctamente.
  </div>
)}

{inscripcionError && (
  <div style="color: red; font-weight: bold; margin: 1rem 0;">
    Error al inscribirse: {inscripcionError.message}
  </div>
)}

{yaInscrito && (
  <div style="color: green; font-weight: bold; margin: 1rem 0;">
    Ya estás inscrito en este evento.
  </div>
)}

{!yaInscrito && (
  <form
    id="form-inscripcion"
    class="container"
    style="max-width: 1200px; margin: 0 auto; font-size: 1.05rem;"
    method="POST"
    enctype="multipart/form-data"
  >
    <input type="hidden" name="idUsuario" value={usuario?.cuentas?.[0]?.id_cue || usuario?.id_usu || ""} />
    <input type="hidden" name="idEvento" value={evento?.id_eve || ""} />
    <div class="form-card" style="padding: 2rem;">
      <h2 style="font-size: 1.6rem;">Inscripción</h2>
      <p>{new Date().toLocaleDateString("es-EC")}</p>

      <h3 style="font-size: 1.3rem;">Datos del Usuario</h3>
      <div class="form-group">
        <label>Correo electrónico</label>
        <input type="email" value={usuario?.cuentas?.[0]?.cor_cue ?? ""} readonly />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Nombre</label>
          <input type="text" value={usuario?.nom_usu1 ?? ""} readonly />
        </div>
        <div class="form-group">
          <label>Apellido</label>
          <input type="text" value={usuario?.ape_usu1 ?? ""} readonly />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Tipo de Documento</label>
          <select disabled>
            <option selected>Cédula</option>
            <option>Pasaporte</option>
          </select>
        </div>
        <div class="form-group">
          <label>Número de Documento</label>
          <input type="text" value={usuario?.ced_usu ?? ""} readonly />
        </div>
      </div>

      <div class="form-group">
        <label>Teléfono</label>
        <input type="tel" value={usuario?.num_tel_usu ?? ""} readonly />
      </div>

      <h3 style="font-size: 1.3rem;">Requisitos</h3>
      <div class="requisitos-container">
        {requisitosCompletos ? (
          requisitos.map((req, index) => (
            <div class="requisito-item">
              <div class="requisito-info">
                <span class="requisito-texto">{req.nom_req}</span>
                <div class="requisito-estado">
                  <input type="checkbox" class="requisito-checkbox" readonly />
                  <label class="custom-checkbox"></label>
                </div>
              </div>
            </div>
          ))
        ) : (
          <p style="color: red;">No hay requisitos registrados para este curso.</p>
        )}
      </div>

      {esPagado && (
        <div class="form-card" style="margin-top: 2rem;">
          <h2 style="font-size: 1.4rem;">Proceso de Pago</h2>
          <div class="form-group">
            <label for="metodoPago">Forma de pago</label>
            <select id="metodoPago" name="metodoPago" required>
              <option value="efectivo">Efectivo</option>
              <option value="transferencia">Transferencia Bancaria</option>
            </select>
          </div>

          <div id="formEfectivo" class="formulario-pago">
            <h4>Pago en Secretaría</h4>
            <p><strong>Lugar:</strong> Secretaría de la FISEI</p>
          </div>

          <div id="formTransferencia" class="formulario-pago">
            <h4>Transferencia Bancaria</h4>
            <p><strong>Banco:</strong> Banco Pichincha</p>
            <p><strong>Cuenta:</strong> Corriente #2206674884</p>
          </div>

          <div class="contenedor-file">
            <label for="file-upload" class="custom-file-upload">
              <img src="/img/CRUD/upload.png" alt="Subir" class="upload-icon" />
              <span>Subir comprobante</span>
            </label>
            <input id="file-upload" name="comprobante" type="file" class="input-file" />
            <p class="file-name">No se ha seleccionado ningún archivo</p>
          </div>
        </div>
      )}

      <div class="form-row" style="margin-top: 2rem;">
        <button class="submit-button" type="button" onclick="history.back()">Cancelar</button>
        <button
          class="submit-button"
          type="submit"
          disabled={!datosUsuarioCompletos || !requisitosCompletos}
        >
          Inscribirse
        </button>
      </div>
    </div>

    <div class="vehicle-card" style="margin-top: 2rem;">
      <h3>{evento?.nom_eve ?? "Evento no disponible"}</h3>
      <img
        src={evento?.img_eve ?? "/img/placeholder.jpg"}
        alt="Curso"
        class="curso-imagen"
      />
      <p><strong>Asignación:</strong> {evento?.eventos_asignaciones?.[0]?.asignaciones?.nom_asi ?? "-"}</p>
      <p><strong>Categoría:</strong> {evento?.categorias_eventos?.nom_cat ?? "-"}</p>
      <p><strong>Precio:</strong> ${evento?.precio ?? "0.00"}</p>
      <p><strong>Área:</strong> {evento?.are_eve ?? "-"}</p>
      <p><strong>Fecha Inicio:</strong> {new Date(evento?.fec_ini_eve ?? "").toLocaleDateString("es-EC")}</p>
      <p><strong>Duración:</strong> {evento?.dur_eve ?? 0} horas</p>
    </div>
  </form>
)}
